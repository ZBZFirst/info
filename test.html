<!DOCTYPE html>
<html>
<head>
    <title>Oxygenation Index Dome Effect</title>
    <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <h2>Oxygenation Index Dome Effect</h2>
    <div id="plot" style="width: 100%; height: 600px;"></div>

    <script type="text/javascript">
        async function main() {
            const pyodide = await loadPyodide();

            await pyodide.loadPackage(['numpy', 'pandas']);

            await pyodide.runPythonAsync(`
import numpy as np
import pandas as pd
import js

# Create the DataFrame
df = pd.DataFrame({
    'FiO2': np.round(0.21 + 0.79 * np.random.rand(1000), 2),
    'MAP': np.round(np.random.uniform(low=5.0, high=50.0, size=1000)),
    'PaO2': np.round(np.random.uniform(low=35.0, high=100.0, size=1000)),
})

df['OI'] = np.round((df['FiO2'] * df['MAP'] * 100) / df['PaO2'])
df['PaO2_normalized'] = np.round((df['PaO2'] - df['PaO2'].min()) / (df['PaO2'].max() - df['PaO2'].min()), 2)

r = np.round(df['PaO2_normalized'] * 2, 2)
theta = np.round(df['FiO2'] * 2 * np.pi, 2)
df['x'] = np.round(r * np.cos(theta), 2)
df['y'] = np.round(r * np.sin(theta), 2)

# Convert DataFrame to dictionary for JS
data = {
    'x': df['x'].tolist(),
    'y': df['y'].tolist(),
    'z': df['OI'].tolist(),
    'color': df['PaO2_normalized'].tolist(),
    'text': ['PaO2: ' + str(p) + '<br>FiO2: ' + str(f) + '<br>MAP: ' + str(m) + '<br>OI: ' + str(o)
             for p, f, m, o in zip(df['PaO2'], df['FiO2'], df['MAP'], df['OI'])]
}

js.data = data
            `);

            const trace = {
                x: data.x,
                y: data.y,
                z: data.z,
                text: data.text,
                mode: 'markers',
                marker: {
                    size: 4,
                    color: data.color,
                    colorscale: 'RdYlGn',
                    colorbar: { title: 'PaO2 Norm' },
                },
                type: 'scatter3d',
                hoverinfo: 'text'
            };

            const layout = {
                title: 'Oxygenation Index Dome Effect',
                scene: {
                    xaxis: { title: 'x' },
                    yaxis: { title: 'y' },
                    zaxis: { title: 'OI' },
                },
                autosize: true
            };

            Plotly.newPlot('plot', [trace], layout);
        }

        main();
    </script>
</body>
</html>