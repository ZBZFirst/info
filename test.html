<!DOCTYPE html>
<html>
<head>
    <title>Oxygenation Index Dome Effect - Debug Mode</title>
    <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #progress-container {
            width: 100%;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        #progress-bar {
            width: 0%;
            height: 30px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 30px;
            color: white;
        }
        #debug-console {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-bottom: 20px;
            background-color: #f8f8f8;
            font-family: monospace;
        }
        #calculation-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .step-container {
            border: 1px solid #ddd;
            padding: 10px;
            flex: 1;
            min-width: 200px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h2>Oxygenation Index Dome Effect - Debug Mode</h2>
    
    <div id="progress-container">
        <div id="progress-bar">Loading Pyodide...</div>
    </div>
    
    <div id="debug-console"></div>
    
    <div id="calculation-steps">
        <div class="step-container" id="step1">
            <h3>Step 1: Raw Data</h3>
            <div id="raw-data-table"></div>
        </div>
        <div class="step-container" id="step2">
            <h3>Step 2: OI Calculation</h3>
            <div id="oi-calculation-table"></div>
        </div>
        <div class="step-container" id="step3">
            <h3>Step 3: Polar Conversion</h3>
            <div id="polar-conversion-table"></div>
        </div>
    </div>
    
    <div id="plot" style="width: 100%; height: 600px;"></div>

    <script type="text/javascript">
        // Debug console functions
        const debugConsole = document.getElementById('debug-console');
        
        function logToConsole(message, type = 'info') {
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            line.style.color = type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'black';
            debugConsole.appendChild(line);
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }
        
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = message;
        }
        
        function createTable(data, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!data || data.length === 0) return;
            
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Create header
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Create rows (limit to 10 for display)
            const displayCount = Math.min(10, data.length);
            for (let i = 0; i < displayCount; i++) {
                const row = document.createElement('tr');
                Object.values(data[i]).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
            
            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
            
            if (data.length > displayCount) {
                const note = document.createElement('div');
                note.textContent = `Showing ${displayCount} of ${data.length} rows...`;
                note.style.fontSize = '0.8em';
                note.style.color = '#666';
                container.appendChild(note);
            }
        }
        
        async function main() {
            try {
                logToConsole('Starting Pyodide initialization...');
                updateProgress(10, 'Loading Pyodide runtime...');
                
                const pyodide = await loadPyodide({
                    stdout: text => logToConsole(`PY: ${text}`),
                    stderr: text => logToConsole(`PY-ERR: ${text}`, 'error')
                });
                
                logToConsole('Pyodide loaded successfully');
                updateProgress(30, 'Loading Python packages...');
                
                // Load required packages
                await pyodide.loadPackage(['numpy', 'pandas']);
                logToConsole('Python packages loaded');
                updateProgress(50, 'Generating data...');
                
                // Run Python code with intermediate steps exposed
                await pyodide.runPythonAsync(`
import numpy as np
import pandas as pd
import js

# Log that we're starting data generation
print("Generating sample data...")

# Create the DataFrame with intermediate logging
fio2 = np.round(0.21 + 0.79 * np.random.rand(1000), 2)
print(f"Generated FiO2 values (first 5): {fio2[:5]}")
map_values = np.round(np.random.uniform(low=5.0, high=50.0, size=1000))
print(f"Generated MAP values (first 5): {map_values[:5]}")
pao2 = np.round(np.random.uniform(low=35.0, high=100.0, size=1000))
print(f"Generated PaO2 values (first 5): {pao2[:5]}")

df = pd.DataFrame({
    'FiO2': fio2,
    'MAP': map_values,
    'PaO2': pao2,
})

# Send raw data to JS for display
raw_data = df.head(10).to_dict('records')
js.displayRawData(raw_data)

# Calculate OI with logging
print("Calculating Oxygenation Index...")
df['OI'] = np.round((df['FiO2'] * df['MAP'] * 100) / df['PaO2'])
print(f"First 5 OI values: {df['OI'].head(5).tolist()}")

# Send OI calculation to JS
oi_data = df[['FiO2', 'MAP', 'PaO2', 'OI']].head(10).to_dict('records')
js.displayOICalculation(oi_data)

# Normalize PaO2
print("Normalizing PaO2 values...")
df['PaO2_normalized'] = np.round((df['PaO2'] - df['PaO2'].min()) / (df['PaO2'].max() - df['PaO2'].min()), 2)
print(f"First 5 normalized PaO2 values: {df['PaO2_normalized'].head(5).tolist()}")

# Convert to polar coordinates with logging
print("Converting to polar coordinates...")
r = np.round(df['PaO2_normalized'] * 2, 2)
theta = np.round(df['FiO2'] * 2 * np.pi, 2)
df['x'] = np.round(r * np.cos(theta), 2)
df['y'] = np.round(r * np.sin(theta), 2)
print(f"First 5 x,y coordinates: {list(zip(df['x'].head(5), df['y'].head(5)))}")

# Send polar conversion to JS
polar_data = df[['PaO2_normalized', 'FiO2', 'x', 'y']].head(10).to_dict('records')
js.displayPolarConversion(polar_data)

# Prepare final data for plotting
print("Preparing final data for visualization...")
data = {
    'x': df['x'].tolist(),
    'y': df['y'].tolist(),
    'z': df['OI'].tolist(),
    'color': df['PaO2_normalized'].tolist(),
    'text': ['PaO2: ' + str(p) + '<br>FiO2: ' + str(f) + '<br>MAP: ' + str(m) + '<br>OI: ' + str(o)
             for p, f, m, o in zip(df['PaO2'], df['FiO2'], df['MAP'], df['OI'])]
}

js.data = data
js.updateProgress(90, 'Rendering plot...')
print("Data preparation complete.")
                `);
                
                // Expose functions to Python
                pyodide.globals.set('displayRawData', rawData => {
                    logToConsole('Displaying raw data sample');
                    createTable(rawData, 'raw-data-table');
                });
                
                pyodide.globals.set('displayOICalculation', oiData => {
                    logToConsole('Displaying OI calculation sample');
                    createTable(oiData, 'oi-calculation-table');
                });
                
                pyodide.globals.set('displayPolarConversion', polarData => {
                    logToConsole('Displaying polar conversion sample');
                    createTable(polarData, 'polar-conversion-table');
                });
                
                pyodide.globals.set('updateProgress', updateProgress);
                
                logToConsole('Data generation complete');
                
                // Create the plot
                const trace = {
                    x: data.x,
                    y: data.y,
                    z: data.z,
                    text: data.text,
                    mode: 'markers',
                    marker: {
                        size: 4,
                        color: data.color,
                        colorscale: 'RdYlGn',
                        colorbar: { title: 'PaO2 Norm' },
                        showscale: true
                    },
                    type: 'scatter3d',
                    hoverinfo: 'text'
                };

                const layout = {
                    title: 'Oxygenation Index Dome Effect',
                    scene: {
                        xaxis: { title: 'x' },
                        yaxis: { title: 'y' },
                        zaxis: { title: 'OI' },
                    },
                    autosize: true,
                    margin: { l: 0, r: 0, b: 0, t: 30 }
                };

                Plotly.newPlot('plot', [trace], layout);
                updateProgress(100, 'Complete!');
                logToConsole('Visualization rendered successfully');
                
            } catch (error) {
                logToConsole(`Error: ${error.message}`, 'error');
                updateProgress(0, `Error: ${error.message}`);
                console.error(error);
            }
        }

        main();
    </script>
</body>
</html>