import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

// Label styles matching Python prototype
const LABEL_STYLES = {
  simple: {
    x: 'X',
    y: 'Y',
    z: 'Z',
    transformed_x: 'Transformed X',
    transformed_y: 'Transformed Y'
  },
  clinical: {
    x: 'Respiratory Rate (breaths/min)',
    y: 'Tidal Volume (mL)',
    z: 'Minute Ventilation (L/min)',
    transformed_x: 'Transformed Respiratory',
    transformed_y: 'Transformed Tidal'
  }
};

// Colormap functions
const COLORMAPS = {
  viridis: (t) => {
    // Simplified viridis colormap
    const c = new THREE.Color();
    c.setHSL(0.3 + t * 0.5, 0.9, 0.5 - t * 0.2);
    return c;
  },
  plasma: (t) => {
    const c = new THREE.Color();
    c.setHSL(0.1 + t * 0.7, 0.9, 0.5);
    return c;
  },
  // Add other colormap implementations...
};

class InteractiveVisualizer {
  constructor(containerId) {
    this.container = document.getElementById(containerId);
    this.data = null;
    this.columns = [];
    this.currentParams = {
      coordSystem: 'cartesian',
      xCol: '',
      yCol: '',
      zCol: '',
      colorBy: 'none',
      cmap: 'viridis',
      alpha: 0.7,
      labelStyle: 'simple'
    };
    
    this.initThreeJS();
    this.initControls();
    this.loadData();
  }

  async loadData() {
    try {
      const response = await fetch('/info/quiz1/x_y_z_data.csv');
      const csv = await response.text();
      this.processData(csv);
    } catch (error) {
      console.error('Error loading data:', error);
      this.showError('Failed to load data');
    }
  }

  processData(csv) {
    const lines = csv.split('\n');
    this.columns = lines[0].split(',').map(col => col.trim());
    this.data = [];
    
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i]) continue;
      const values = lines[i].split(',');
      const point = {};
      this.columns.forEach((col, j) => {
        point[col] = parseFloat(values[j]);
      });
      this.data.push(point);
    }
    
    this.setupUI();
    this.updateVisualization();
  }

  setupUI() {
    // Populate dropdowns
    const populateSelect = (id, includeNone = false) => {
      const select = document.getElementById(id);
      select.innerHTML = '';
      
      if (includeNone) {
        const option = document.createElement('option');
        option.value = 'none';
        option.textContent = 'None';
        select.appendChild(option);
      }
      
      this.columns.forEach(col => {
        const option = document.createElement('option');
        option.value = col;
        option.textContent = col;
        select.appendChild(option);
      });
      
      // Set default value based on expected columns
      if (id === 'x-col' && this.columns.includes('x')) {
        select.value = 'x';
      } else if (id === 'y-col' && this.columns.includes('y')) {
        select.value =
