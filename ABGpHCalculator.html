<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ABG Interpreter - Acid-Base Nomogram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .calculator {
            background-color: #f5f5f5;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider {
            flex-grow: 1;
        }
        .slider-value {
            min-width: 50px;
            text-align: center;
        }
        .slider-button {
            background-color: #3498db;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .slider-button:hover {
            background-color: #2980b9;
        }
        .normal-range {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
            border-left: 5px solid;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error {
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 5px;
            display: none;
        }
        .interpretation {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0 10px;
        }
        .parameters {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .parameter {
            background-color: #ecf0f1;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            flex: 1;
            min-width: 120px;
            margin-right: 10px;
            text-align: center;
        }
        .parameter:last-child {
            margin-right: 0;
        }
        .parameter-value {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        #graph-container {
            width: 100%;
            height: 500px;
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }
        .reference {
            margin-top: 30px;
            font-size: 14px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Advanced ABG Interpreter - Acid-Base Nomogram</h1>
    <p class="subtitle">Interactive acid-base nomogram with PaCO₂ isolines</p>
    
    <div class="calculator">
        <div class="input-group">
            <label for="hco3">HCO₃⁻ (mEq/L):</label>
            <div class="slider-container">
                <button class="slider-button" onclick="adjustValue('hco3', -1)">-</button>
                <input type="range" id="hco3-slider" class="slider" min="10" max="50" step="0.1" value="24">
                <button class="slider-button" onclick="adjustValue('hco3', 1)">+</button>
                <span id="hco3-value" class="slider-value">24.0</span>
            </div>
            <input type="hidden" id="hco3" value="24">
            <div class="normal-range">Normal range: 22 - 26 mEq/L</div>
        </div>
        
        <div class="input-group">
            <label for="paco2">PaCO₂ (mmHg):</label>
            <div class="slider-container">
                <button class="slider-button" onclick="adjustValue('paco2', -1)">-</button>
                <input type="range" id="paco2-slider" class="slider" min="10" max="100" step="0.1" value="40">
                <button class="slider-button" onclick="adjustValue('paco2', 1)">+</button>
                <span id="paco2-value" class="slider-value">40.0</span>
            </div>
            <input type="hidden" id="paco2" value="40">
            <div class="normal-range">Normal range: 35 - 45 mmHg</div>
        </div>
        
        <button onclick="interpretABG()">Interpret ABG</button>
        
        <div id="error" class="error"></div>
        
        <div id="result" class="result">
            <h3>Interpretation Result</h3>
            <div class="interpretation" id="interpretation-text">-</div>
            
            <div class="parameters">
                <div class="parameter">
                    <div>Calculated pH</div>
                    <div class="parameter-value" id="result-ph">-</div>
                </div>
                <div class="parameter">
                    <div>PaCO₂</div>
                    <div class="parameter-value" id="result-paco2">-</div>
                </div>
                <div class="parameter">
                    <div>HCO₃⁻</div>
                    <div class="parameter-value" id="result-hco3">-</div>
                </div>
            </div>
        </div>
    </div>

    <div id="graph-container"></div>

    <div class="reference">
        <p><strong>Reference:</strong> Based on the Henderson-Hasselbalch equation and standard acid-base nomograms.</p>
    </div>

    <script>
        // Initialize the graph on page load
        window.onload = function() {
            initializeGraph();
            setupSliders();
            interpretABG();
        };

        function setupSliders() {
            // HCO3 slider
            document.getElementById('hco3-slider').addEventListener('input', function() {
                const value = parseFloat(this.value).toFixed(1);
                document.getElementById('hco3-value').textContent = value;
                document.getElementById('hco3').value = value;
                interpretABG();
            });

            // PaCO2 slider
            document.getElementById('paco2-slider').addEventListener('input', function() {
                const value = parseFloat(this.value).toFixed(1);
                document.getElementById('paco2-value').textContent = value;
                document.getElementById('paco2').value = value;
                interpretABG();
            });
        }

        function adjustValue(param, change) {
            const slider = document.getElementById(`${param}-slider`);
            const currentValue = parseFloat(slider.value);
            const step = parseFloat(slider.step);
            const newValue = (currentValue + (change * step)).toFixed(1);
            
            // Ensure value stays within min/max bounds
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            
            if (newValue >= min && newValue <= max) {
                slider.value = newValue;
                document.getElementById(`${param}-value`).textContent = newValue;
                document.getElementById(param).value = newValue;
                interpretABG();
            }
        }

        function interpretABG() {
            // Get input values
            const paco2 = parseFloat(document.getElementById('paco2').value);
            const hco3 = parseFloat(document.getElementById('hco3').value);
            
            // Clear previous results and errors
            document.getElementById('error').textContent = '';
            document.getElementById('error').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            
            // Validate inputs
            if (isNaN(paco2) {
                showError('Invalid PaCO₂ value');
                return;
            }
            
            if (isNaN(hco3)) {
                showError('Invalid HCO₃⁻ value');
                return;
            }
            
            // Calculate pH using Henderson-Hasselbalch equation
            const ph = calculatePH(paco2, hco3);
            
            // Classify ABG
            const [interpretation, color] = classifyABG(ph, paco2, hco3);
            
            // Display results
            document.getElementById('interpretation-text').textContent = interpretation;
            document.getElementById('interpretation-text').style.color = color;
            document.getElementById('result-ph').textContent = ph.toFixed(2);
            document.getElementById('result-paco2').textContent = paco2.toFixed(1);
            document.getElementById('result-hco3').textContent = hco3.toFixed(1);
            
            // Set border color based on interpretation
            document.getElementById('result').style.borderLeftColor = color;
            
            // Show result
            document.getElementById('result').style.display = 'block';
            
            // Update graph
            updateGraph();
        }
        
        function calculatePH(paco2, hco3) {
            // Henderson-Hasselbalch equation: pH = 6.1 + log10(HCO3 / (0.03 * PaCO2))
            return 6.1 + Math.log10(hco3 / (0.03 * paco2));
        }
        
        function classifyABG(pH, PaCO2, HCO3) {
            // Simplified classification for demo purposes
            if (pH < 7.35) {
                if (PaCO2 > 45) return ["Respiratory Acidosis", 'tomato'];
                if (HCO3 < 22) return ["Metabolic Acidosis", 'darkorange'];
                return ["Mixed Acidosis", 'crimson'];
            } else if (pH > 7.45) {
                if (PaCO2 < 35) return ["Respiratory Alkalosis", 'dodgerblue'];
                if (HCO3 > 26) return ["Metabolic Alkalosis", 'deepskyblue'];
                return ["Mixed Alkalosis", 'violet'];
            } else {
                if (35 <= PaCO2 && PaCO2 <= 45 && 22 <= HCO3 && HCO3 <= 26) {
                    return ["Normal", 'green'];
                }
                return ["Compensated or Mixed Disorder", 'gray'];
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function initializeGraph() {
            // Generate data for PaCO2 isolines (10 to 100 mmHg in 10 mmHg increments)
            const paco2Values = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
            const hco3Range = Array.from({length: 41}, (_, i) => i + 10); // 10 to 50 mEq/L
            
            // Create traces for each PaCO2 isoline
            const traces = paco2Values.map(paco2 => {
                // For each PaCO2, calculate pH as function of HCO3: pH = 6.1 + log10(HCO3 / (0.03 * PaCO2))
                const pHValues = hco3Range.map(hco3 => 6.1 + Math.log10(hco3 / (0.03 * paco2)));
                
                return {
                    x: hco3Range,
                    y: pHValues,
                    mode: 'lines',
                    name: `PaCO₂ ${paco2} mmHg`,
                    line: {
                        width: 2,
                        color: getColorForPaCO2(paco2)
                    },
                    hoverinfo: 'name'
                };
            });
            
            // Add normal range box
            traces.push({
                x: [22, 22, 26, 26, 22],
                y: [7.35, 7.45, 7.45, 7.35, 7.35],
                mode: 'lines',
                fill: 'toself',
                name: 'Normal Range',
                line: {
                    color: 'green',
                    width: 2
                },
                fillcolor: 'rgba(0, 128, 0, 0.1)',
                hoverinfo: 'name'
            });
            
            // Layout configuration
            const layout = {
                title: 'Acid-Base Nomogram',
                xaxis: {
                    title: 'HCO₃⁻ (mEq/L)',
                    range: [10, 50]
                },
                yaxis: {
                    title: 'pH',
                    range: [7.0, 7.7]
                },
                hovermode: 'closest',
                margin: { t: 50, b: 50, l: 50, r: 50 },
                legend: {
                    orientation: 'h',
                    y: -0.3
                },
                showlegend: true
            };
            
            // Create the plot
            Plotly.newPlot('graph-container', traces, layout);
        }
        
        function updateGraph() {
            // Get current values
            const paco2 = parseFloat(document.getElementById('paco2').value);
            const hco3 = parseFloat(document.getElementById('hco3').value);
            const ph = calculatePH(paco2, hco3);
            
            // Update the point in the graph (add new trace if it doesn't exist)
            const pointTrace = {
                x: [hco3],
                y: [ph],
                mode: 'markers',
                name: 'Current Values',
                marker: {
                    size: 12,
                    color: 'red',
                    symbol: 'circle'
                },
                text: [`PaCO₂: ${paco2.toFixed(1)} mmHg`],
                hoverinfo: 'text+name'
            };
            
            // Check if the point trace already exists
            const graphDiv = document.getElementById('graph-container');
            const currentData = graphDiv.data;
            
            if (currentData.length > 10) { // We have 10 PaCO2 lines + 1 normal range
                // Update existing point trace
                Plotly.restyle('graph-container', {
                    x: [[hco3]],
                    y: [[ph]],
                    text: [[`PaCO₂: ${paco2.toFixed(1)} mmHg`]]
                }, [10]); // Index of the point trace
            } else {
                // Add new point trace
                Plotly.addTraces('graph-container', pointTrace);
            }
        }
        
        function getColorForPaCO2(paco2) {
            // Color gradient from blue (low PaCO2) to red (high PaCO2)
            const ratio = (paco2 - 10) / 90; // Normalize to 0-1 range
            const r = Math.round(255 * ratio);
            const b = Math.round(255 * (1 - ratio));
            return `rgb(${r}, 0, ${b})`;
        }
    </script>
</body>
</html>
